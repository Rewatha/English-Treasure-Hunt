<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasure Hunt - English Day Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://jvqkzkzhotgacfmlkbxs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FvLS_jRu5150a9StB01SsA_7enG13UJ';

        // Create the connection
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Envelope 1: Vocabulary Puzzles
        const VOCABULARY_PUZZLES = [
            { question: "I am a word that means both 'to tolerate' and 'the edge of the sea.' What am I?", answer: "coast", hint: "Think about the coastline" },
            { question: "Add one letter to me, and I become smaller. I am a five-letter word.", answer: "short", hint: "Think about the word 'short'" },
            { question: "Find the odd word: Eloquent, Fluent, Talkative, Silent", answer: "silent", hint: "Which one means NOT talking?" },
            { question: "My prefix is a pronoun, my suffix is a weapon, and I mean 'to finish.'", answer: "end", hint: "Starts with 'e'" },
            { question: "I sound like two letters, but I'm written with three. I'm used to make things plural.", answer: "s", hint: "The letter that makes words plural" },
            { question: "I'm a word that contains every vowel once and in order.", answer: "facetious", hint: "A-E-I-O-U in order" },
            { question: "Change one letter in 'Teach' to make it mean 'snatch quickly.'", answer: "reach", hint: "Change the 'T'" }
        ];

        // Envelope 2: Grammar Puzzles
        const GRAMMAR_PUZZLES = [
            { question: "Neither of the students ___ present. (Are/Is)", answer: "is", hint: "'Neither' is singular" },
            { question: "Find the error: 'She don't like coffee but enjoy tea.' Type the corrected sentence (no spaces)", answer: "shedoesntlikecoffeebutenjoystea", hint: "Change 'don't' and 'enjoy'" },
            { question: "Identify the tense: 'He has been studying since morning.'", answer: "presentperfectcontinuous", hint: "Has been + verb-ing" },
            { question: "Which is correct? Type: was OR were - 'I wish I ___ taller'", answer: "were", hint: "Subjunctive mood uses 'were'" },
            { question: "He runs faster than ___ in the class. Type: anyboy OR anyotherboy", answer: "anyotherboy", hint: "Need to exclude himself" },
            { question: "Unscramble: 'NGOIC' (used to describe action)", answer: "ongoing", hint: "Continuous action" },
            { question: "Identify the figure of speech: 'He runs like the wind.'", answer: "simile", hint: "Comparison using 'like' or 'as'" },
            { question: "What's the collective noun for 'keys'?", answer: "bunch", hint: "A ___ of keys" }
        ];

        // Envelope 3: Idiom & Cipher Puzzles
        const IDIOM_CIPHER_PUZZLES = [
            { question: "What does 'Barking up the wrong tree' mean?", answer: "accusingthewrongperson", hint: "Wrong direction/person" },
            { question: "What does 'Burning the midnight oil' mean?", answer: "workinglate", hint: "Working at night" },
            { question: "What does 'The ball is in your court' mean?", answer: "yourdecision", hint: "It's up to you now" },
            { question: "What does 'Break a leg!' mean?", answer: "goodluck", hint: "Theater saying for luck" },
            { question: "Decode this: 13-1-19-20-5-18 (A=1, B=2, C=3...)", answer: "master", hint: "M=13, A=1, S=19..." },
            { question: "Rearrange: 'DREA'", answer: "read", hint: "Past tense: read" },
            { question: "Hidden word in: 'Every dictionary hides its meaning.'", answer: "hide", hint: "Look at the word 'hides'" }
        ];

        // Envelope 4: Logic Puzzles
        const LOGIC_PUZZLES = [
            { question: "The more of me you take, the more you leave behind.", answer: "footsteps", hint: "Walking creates these" },
            { question: "I have keys but no locks, space but no room.", answer: "keyboard", hint: "Computer accessory" },
            { question: "I'm seen once in a minute, twice in a moment, never in a thousand years.", answer: "m", hint: "It's a letter" },
            { question: "What has a face and two hands but no arms?", answer: "clock", hint: "Tells time" },
            { question: "If TWO is company and THREE is a crowd, what is FOUR and FIVE?", answer: "nine", hint: "4 + 5 = ?" },
            { question: "Find the next in sequence: O, T, T, F, F, S, S, E...", answer: "n", hint: "One, Two, Three, Four..." },
            { question: "I am a word that starts and ends with the same letter, and I contain one.", answer: "eye", hint: "Used for seeing" },
            { question: "I speak without a mouth, hear without ears.", answer: "echo", hint: "Sound reflection" },
            { question: "I am always in front of you but can't be seen.", answer: "future", hint: "Tomorrow and beyond" }
        ];

        // Envelope 5: Final Treasure Codes
        const TREASURE_CODES = [
            { question: "Unscramble the phrase: ELHET SRUSAER SI EERH", answer: "thetreasureishere", hint: "THE ___ IS ___" },
            { question: "I am the beginning of the end and the end of time and space. What letter?", answer: "e", hint: "Look at the words: End, timE, spacE" },
            { question: "Decode this cipher: 20-18-5-1-19-21-18-5 (A=1, B=2...)", answer: "treasure", hint: "T=20, R=18, E=5..." },
            { question: "Find the missing letters: TH_ TR_A_UR_ IS H_R_", answer: "thetreasureishere", hint: "THE TREASURE IS HERE" },
            { question: "Reverse this message: .ereh si erusaert ehT", answer: "thetreasureishere", hint: "Read backwards" },
            { question: "If 'word' = 4 and 'language' = 8, then 'treasure' = ?", answer: "8", hint: "Count the letters" },
            { question: "Pattern riddle: Begin with book, move to key, end with word. Where am I?", answer: "dictionary", hint: "Where you find word definitions" },
            { question: "Cryptic anagram: SILENT = LISTEN. Now rearrange EARTH", answer: "heart", hint: "Rearrange the letters" }
        ];

        // Icons
        const Clock = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "20", height: "20", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('polyline', { points: "12 6 12 12 16 14" }));

        const Trophy = () => React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: "64", height: "64", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2" }, React.createElement('path', { d: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6" }), React.createElement('path', { d: "M18 9h1.5a2.5 2.5 0 0 0 0-5H18" }), React.createElement('path', { d: "M4 22h16" }), React.createElement('path', { d: "M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" }), React.createElement('path', { d: "M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" }), React.createElement('path', { d: "M18 2H6v7a6 6 0 0 0 12 0V2Z" }));

        function TreasureHunt() {
            const [playerName, setPlayerName] = useState('');
            const [currentEnvelope, setCurrentEnvelope] = useState(1);
            const [currentPuzzle, setCurrentPuzzle] = useState(null);
            const [usedPuzzleIds, setUsedPuzzleIds] = useState([]);
            const [answer, setAnswer] = useState('');
            const [timeLeft, setTimeLeft] = useState(480);
            const [totalSkipsLeft, setTotalSkipsLeft] = useState(2);
            const [showHint, setShowHint] = useState(false);
            const [isComplete, setIsComplete] = useState(false);
            const [wrongAnswer, setWrongAnswer] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const [completedEnvelopes, setCompletedEnvelopes] = useState([]);
            const [totalHintsUsed, setTotalHintsUsed] = useState(0);
            const [totalSkipsUsed, setTotalSkipsUsed] = useState(0);

            useEffect(() => {
                try {
                    const currentPlayer = localStorage.getItem('currentPlayer');
                    const picturePuzzle = localStorage.getItem('picturePuzzleCompleted');
                    const riddleChallenge = localStorage.getItem('riddleChallengeCompleted');

                    if (!currentPlayer || picturePuzzle !== 'true' || riddleChallenge !== 'true') {
                        window.location.href = 'index.html';
                        return;
                    }

                    const player = JSON.parse(currentPlayer);
                    setPlayerName(player.name);
                    setStartTime(Date.now());
                    loadPuzzle(1);
                } catch (e) {
                    window.location.href = 'index.html';
                }
            }, []);

            useEffect(() => {
                if (!isComplete && timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && !isComplete) {
                    saveAttempt(false);
                    window.location.href = 'results.html';
                }
            }, [timeLeft, isComplete]);

            const getPuzzleBank = (envelopeNum) => {
                switch (envelopeNum) {
                    case 1: return VOCABULARY_PUZZLES;
                    case 2: return GRAMMAR_PUZZLES;
                    case 3: return IDIOM_CIPHER_PUZZLES;
                    case 4: return LOGIC_PUZZLES;
                    case 5: return TREASURE_CODES;
                }
            };

            const loadPuzzle = (envelopeNum) => {
                const puzzles = getPuzzleBank(envelopeNum);
                const availablePuzzles = puzzles.filter((p, idx) => !usedPuzzleIds.includes(idx));

                if (availablePuzzles.length === 0) {
                    setUsedPuzzleIds([]);
                    const randomPuzzle = puzzles[Math.floor(Math.random() * puzzles.length)];
                    setCurrentPuzzle(randomPuzzle);
                } else {
                    const randomPuzzle = availablePuzzles[Math.floor(Math.random() * availablePuzzles.length)];
                    const puzzleIndex = puzzles.indexOf(randomPuzzle);
                    setUsedPuzzleIds([...usedPuzzleIds, puzzleIndex]);
                    setCurrentPuzzle(randomPuzzle);
                }

                setAnswer('');
                setWrongAnswer(false);
                setShowHint(false);
            };

            const checkAnswer = () => {
                if (!answer.trim()) return;

                const userAnswer = answer.toLowerCase().trim().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
                const correctAnswer = currentPuzzle.answer.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');

                if (userAnswer === correctAnswer) {
                    setWrongAnswer(false);
                    setCompletedEnvelopes([...completedEnvelopes, currentEnvelope]);

                    if (currentEnvelope === 5) {
                        setIsComplete(true);
                        saveAttempt(true);
                        setTimeout(() => window.location.href = 'results.html', 2000);
                    } else {
                        const nextEnvelope = currentEnvelope + 1;
                        setCurrentEnvelope(nextEnvelope);
                        setUsedPuzzleIds([]);
                        loadPuzzle(nextEnvelope);
                    }
                } else {
                    setWrongAnswer(true);
                }
            };

            const handleSkipQuestion = () => {
                if (totalSkipsLeft <= 0) return;
                setTotalSkipsLeft(totalSkipsLeft - 1);
                setTotalSkipsUsed(totalSkipsUsed + 1);
                setTimeLeft(Math.max(0, timeLeft - 30));
                loadPuzzle(currentEnvelope);
            };

            const handleShowHint = () => {
                if (!showHint) {
                    setShowHint(true);
                    setTimeLeft(Math.max(0, timeLeft - 60));
                    setTotalHintsUsed(totalHintsUsed + 1);
                }
            };

            const handleGiveUp = () => {
                if (currentEnvelope === 5) {
                    saveAttempt(false);
                    window.location.href = 'results.html';
                } else {
                    const nextEnvelope = currentEnvelope + 1;
                    setCurrentEnvelope(nextEnvelope);
                    setUsedPuzzleIds([]);
                    loadPuzzle(nextEnvelope);
                }
            };

            const saveAttempt = async (completed) => {
                try {
                    const currentPlayer = JSON.parse(localStorage.getItem('currentPlayer'));
                    const timeTaken = Math.floor((Date.now() - startTime) / 1000);

                    // 1. Keep LocalStorage (So the Results page still works immediately)
                    const attemptData = {
                        completed: completed,
                        timeTaken: timeTaken,
                        envelopesCompleted: completedEnvelopes.length,
                        totalHintsUsed: totalHintsUsed,
                        totalSkipsUsed: totalSkipsUsed,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('lastAttempt', JSON.stringify(attemptData));

                    // 2. SEND TO SUPABASE CLOUD
                    // We use the client you created at the top of the script
                    const { error } = await supabaseClient
                        .from('leaderboard')
                        .insert([
                            {
                                player_name: currentPlayer.name,
                                player_gmail: currentPlayer.gmail,
                                score: completedEnvelopes.length,
                                time_taken: timeTaken
                            }
                        ]);

                    if (error) {
                        console.error('Supabase Error:', error);
                    } else {
                        console.log('‚úÖ Score saved to Cloud Database!');
                    }

                } catch (e) {
                    console.error('Error saving attempt:', e);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !isComplete) checkAnswer();
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const getEnvelopeName = (num) => ['', 'Vocabulary Vault', 'Grammar Gate', 'Idiom/Cipher Code', 'Logic Lock', 'Final Treasure'][num];
            const getEnvelopeEmoji = (num) => ['', 'üìö', 'üìù', 'üîê', 'üß†', 'üèÜ'][num];

            if (isComplete) {
                return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center" },
                        React.createElement('div', { className: "mb-6 flex justify-center animate-bounce" }, React.createElement(Trophy)),
                        React.createElement('h1', { className: "text-4xl font-bold text-yellow-600 mb-4" }, 'üéâ TREASURE FOUND!'),
                        React.createElement('p', { className: "text-xl text-gray-700" }, 'Redirecting to results...')
                    )
                );
            }

            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-800 p-4" },
                React.createElement('div', { className: "max-w-2xl mx-auto" },
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-xl p-6 mb-6" },
                        React.createElement('div', { className: "flex justify-between items-center mb-4" },
                            React.createElement('div', null,
                                React.createElement('h2', { className: "text-2xl font-bold text-gray-800" }, 'üè¥‚Äç‚ò†Ô∏è Treasure Hunt'),
                                React.createElement('p', { className: "text-sm text-gray-600" }, playerName + ' - Keep going!')
                            ),
                            React.createElement('div', { className: "text-center bg-gradient-to-r from-red-500 to-orange-500 text-white px-6 py-3 rounded-full " + (timeLeft <= 60 ? 'pulse-animation' : '') },
                                React.createElement('div', { className: "font-bold text-2xl" }, React.createElement(Clock), ' ' + formatTime(timeLeft))
                            )
                        ),
                        React.createElement('div', { className: "mb-2" },
                            React.createElement('div', { className: "flex justify-between text-sm text-gray-600 mb-2" },
                                React.createElement('span', null, 'Progress'),
                                React.createElement('span', null, `Envelope ${currentEnvelope} of 5`)
                            ),
                            React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-4" },
                                React.createElement('div', { className: "bg-gradient-to-r from-green-500 to-emerald-600 h-4 rounded-full transition-all", style: { width: `${completedEnvelopes.length / 5 * 100}%` } })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-between mt-4" },
                            [1, 2, 3, 4, 5].map(num =>
                                React.createElement('div', { key: num, className: "text-center " + (completedEnvelopes.includes(num) ? 'opacity-50' : num === currentEnvelope ? 'scale-110' : 'opacity-30') },
                                    React.createElement('div', { className: "text-3xl mb-1" }, getEnvelopeEmoji(num)),
                                    React.createElement('div', { className: "text-xs font-semibold text-gray-700" }, completedEnvelopes.includes(num) ? '‚úÖ' : num === currentEnvelope ? '‚ñ∂Ô∏è' : '‚è∏')
                                )
                            )
                        )
                    ),

                    React.createElement('div', { className: "bg-white rounded-3xl shadow-2xl p-8" },
                        React.createElement('div', { className: "text-center mb-6" },
                            React.createElement('div', { className: "text-6xl mb-4" }, getEnvelopeEmoji(currentEnvelope)),
                            React.createElement('h3', { className: "text-3xl font-bold text-gray-800 mb-2" }, 'Envelope ' + currentEnvelope),
                            React.createElement('p', { className: "text-lg text-purple-600 font-semibold" }, getEnvelopeName(currentEnvelope)),
                            React.createElement('p', { className: "text-sm text-gray-600 mt-2" }, `‚è≠Ô∏è Total Game Skips: ${totalSkipsLeft}/2 | Each skip: -30 sec`)
                        ),

                        React.createElement('div', { className: "bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-8 mb-6" },
                            React.createElement('p', { className: "text-xl text-gray-800 leading-relaxed text-center mb-4" }, currentPuzzle ? currentPuzzle.question : 'Loading...'),
                            showHint && currentPuzzle && React.createElement('div', { className: "mt-4 text-center bg-yellow-100 p-4 rounded-xl" },
                                React.createElement('span', { className: "text-sm text-gray-800 font-semibold" }, 'üí° Hint: ' + currentPuzzle.hint)
                            )
                        ),

                        React.createElement('div', { className: "mb-6" },
                            React.createElement('label', { className: "block text-sm font-semibold text-gray-700 mb-2" }, 'Your Answer:'),
                            React.createElement('input', {
                                type: "text",
                                value: answer,
                                onChange: (e) => setAnswer(e.target.value),
                                onKeyPress: handleKeyPress,
                                placeholder: "Type your answer here",
                                className: "w-full px-4 py-4 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none transition-colors text-center text-xl " + (wrongAnswer ? 'border-red-500 bg-red-50' : ''),
                                autoFocus: true
                            }),
                            wrongAnswer && React.createElement('p', { className: "text-red-600 text-sm mt-2 text-center font-semibold" }, '‚ùå Incorrect! Try again.')
                        ),

                        React.createElement('div', { className: "grid grid-cols-2 gap-4 mb-4" },
                            React.createElement('button', {
                                onClick: handleShowHint,
                                disabled: showHint,
                                className: "bg-yellow-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-yellow-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            }, showHint ? 'üí° Hint Shown' : 'üí° Show Hint (-1 min)'),

                            React.createElement('button', {
                                onClick: handleSkipQuestion,
                                disabled: totalSkipsLeft <= 0,
                                className: "bg-orange-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-orange-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            }, `‚è≠Ô∏è Skip Question (${totalSkipsLeft}/2) -30s`)
                        ),

                        React.createElement('button', {
                            onClick: checkAnswer,
                            disabled: !answer.trim(),
                            className: "w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed mb-4"
                        }, '‚úÖ Submit Answer'),

                        React.createElement('button', {
                            onClick: handleGiveUp,
                            className: "w-full bg-red-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-red-600 transition-all"
                        }, currentEnvelope === 5 ? 'üèÅ Finish Game (No Marks for Envelope 5)' : `‚û°Ô∏è Give Up - Next Envelope (No Marks for Envelope ${currentEnvelope})`)
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(TreasureHunt));
    </script>
</body>

</html>