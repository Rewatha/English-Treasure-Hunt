<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - English Treasure Hunt</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-indigo-900 to-purple-900 min-h-screen p-4">
    <div id="root"></div>
    <script>
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://jvqkzkzhotgacfmlkbxs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_FvLS_jRu5150a9StB01SsA_7enG13UJ';

        // Create the connection
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function Leaderboard() {
            const [rankings, setRankings] = useState([]);

            useEffect(() => {
                const allData = [];
                // Loop through localStorage to find all player data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('player_')) {
                        try {
                            const player = JSON.parse(localStorage.getItem(key));
                            // Use the most recent attempt for ranking
                            const lastAttempt = player.attempts ? player.attempts[player.attempts.length - 1] : null;

                            if (lastAttempt) {
                                allData.push({
                                    name: player.name,
                                    gmail: player.gmail,
                                    score: lastAttempt.envelopesCompleted || 0,
                                    time: lastAttempt.timeTaken || 9999,
                                    completed: lastAttempt.completed
                                });
                            }
                        } catch (e) { console.error("Error parsing player data"); }
                    }
                }

                // Sort by envelopes completed (High to Low), then by time (Low to High)
                const sorted = allData.sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.time - b.time;
                });

                setRankings(sorted);
            }, []);

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            return React.createElement('div', { className: "max-w-4xl mx-auto py-10" },
                React.createElement('h1', { className: "text-4xl font-bold text-white text-center mb-8" }, "üèÜ Treasure Hunt Leaderboard"),
                React.createElement('div', { className: "bg-white rounded-3xl shadow-2xl overflow-hidden" },
                    React.createElement('table', { className: "w-full text-left" },
                        React.createElement('thead', { className: "bg-gray-100 border-b" },
                            React.createElement('tr', null,
                                React.createElement('th', { className: "px-6 py-4" }, "Rank"),
                                React.createElement('th', { className: "px-6 py-4" }, "Player"),
                                React.createElement('th', { className: "px-6 py-4" }, "Envelopes"),
                                React.createElement('th', { className: "px-6 py-4" }, "Time")
                            )
                        ),
                        React.createElement('tbody', null,
                            rankings.length === 0 ?
                                React.createElement('tr', null, React.createElement('td', { colSpan: 4, className: "text-center py-10 text-gray-500" }, "No attempts recorded yet!")) :
                                rankings.map((player, index) =>
                                    React.createElement('tr', { key: index, className: "border-b hover:bg-blue-50 transition-colors" },
                                        React.createElement('td', { className: "px-6 py-4 font-bold" }, index + 1),
                                        React.createElement('td', { className: "px-6 py-4" },
                                            React.createElement('div', { className: "font-bold text-gray-800" }, player.name),
                                            React.createElement('div', { className: "text-xs text-gray-500" }, player.gmail)
                                        ),
                                        React.createElement('td', { className: "px-6 py-4" },
                                            React.createElement('span', { className: "px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold" }, player.score + " / 5")
                                        ),
                                        React.createElement('td', { className: "px-6 py-4 font-mono" }, formatTime(player.time))
                                    )
                                )
                        )
                    )
                ),
                React.createElement('div', { className: "mt-8 text-center" },
                    React.createElement('button', {
                        onClick: () => window.location.href = 'index.html',
                        className: "bg-white text-purple-700 font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-gray-100 transition-all"
                    }, "üè† Back to Login")
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(Leaderboard));
    </script>
</body>

</html>